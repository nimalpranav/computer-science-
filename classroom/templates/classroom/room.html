<!DOCTYPE html>
<html>
<head>
  <title>Classroom</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col h-screen">

  <!-- Header -->
  <header class="bg-indigo-600 text-white p-4 shadow-lg">
    <h1 class="text-2xl font-bold">Classroom: {{ room_name }}</h1>
  </header>

  <!-- Main content -->
  <main class="flex flex-1 p-4 space-x-4">

    <!-- Chat Section -->
    <section class="flex flex-col w-2/3 bg-white rounded-2xl shadow-lg p-4">
      <h2 class="text-lg font-semibold mb-2">üí¨ Chat</h2>
      
      <div id="chat-log"
        class="flex-1 w-full p-2 border rounded-lg mb-3 bg-gray-50 overflow-y-auto space-y-2">
        <!-- Messages go here -->
      </div>

      <div class="flex space-x-2">
        <input id="chat-message-input" type="text"
          class="flex-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
          placeholder="Type a message...">
        <button id="chat-message-submit"
          class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600">Send</button>
        <button id="chat-message-voice"
          class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600">TTS</button>
        <button id="start-record"
          class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">üéôÔ∏è Start</button>
        <button id="stop-record"
          class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">‚èπÔ∏è Stop</button>
      </div>
    </section>

    <!-- Voice Section -->
    <section class="flex flex-col w-1/3 bg-white rounded-2xl shadow-lg p-4">
      <h2 class="text-lg font-semibold mb-2">üéß Live Voice</h2>
      <button id="start-voice"
        class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 mb-4">Join Voice</button>
      <audio id="remoteAudio" autoplay controls class="w-full"></audio>
    </section>

  </main>

  <!-- Footer -->
  <footer class="bg-gray-200 text-center p-2 text-sm">
    Powered by Django + Channels + WebRTC
  </footer>

  <script>
    const roomName = "{{ room_name }}";
    const ws = new WebSocket(
      (window.location.protocol === "https:" ? "wss://" : "ws://") +
      window.location.host +
      "/ws/classroom/" + roomName + "/"
    );

    const chatLog = document.querySelector('#chat-log');
    const messageInput = document.querySelector('#chat-message-input');

    // Load old messages
    const savedChat = localStorage.getItem('chatLog_' + roomName);
    if (savedChat) chatLog.innerHTML = savedChat;

    function appendMessage(html) {
      const wrapper = document.createElement("div");
      wrapper.innerHTML = html;
      chatLog.appendChild(wrapper);
      localStorage.setItem('chatLog_' + roomName, chatLog.innerHTML);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    ws.onmessage = function(e) {
      const data = JSON.parse(e.data);

      if (data.message) {
        appendMessage(`<div class="p-2 bg-indigo-100 rounded">${data.message}</div>`);
        if (data.is_voice) {
          speechSynthesis.speak(new SpeechSynthesisUtterance(data.message));
        }
      }

      if (data.voice_blob) {
        const audioId = "audio-" + Date.now();
        appendMessage(`
          <div class="p-2 bg-green-100 rounded flex items-center space-x-2">
            <span>üéôÔ∏è Voice Message:</span>
            <audio id="${audioId}" controls src="${data.voice_blob}"></audio>
          </div>
        `);
      }
    };

    function sendMessage(isVoice) {
      const message = messageInput.value.trim();
      if (!message) return;
      ws.send(JSON.stringify({ message: message, is_voice: isVoice }));
      messageInput.value = "";
    }

    document.querySelector('#chat-message-submit').onclick = () => sendMessage(false);
    document.querySelector('#chat-message-voice').onclick = () => sendMessage(true);
    messageInput.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage(false);
      }
    });

    // üé§ Recording
    let mediaRecorder, audioChunks = [];
    document.querySelector('#start-record').onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const reader = new FileReader();
        reader.onloadend = () => {
          ws.send(JSON.stringify({ voice_blob: reader.result }));
          console.log("üì§ Sent recorded voice message");
        };
        reader.readAsDataURL(audioBlob);
      };

      mediaRecorder.start();
      console.log("üéôÔ∏è Recording started...");
    };

    document.querySelector('#stop-record').onclick = () => {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
        console.log("‚èπÔ∏è Recording stopped.");
      }
    };

    // üî¥ Live voice (WebRTC)
    let pc = null;
    document.querySelector('#start-voice').onclick = async function() {
      pc = new RTCPeerConnection();
      pc.onicecandidate = e => { if (e.candidate) ws.send(JSON.stringify({ candidate: e.candidate })); };
      pc.ontrack = e => document.querySelector('#remoteAudio').srcObject = e.streams[0];

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      stream.getTracks().forEach(track => pc.addTrack(track, stream));

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      ws.send(JSON.stringify({ offer: offer }));
    };
  </script>
</body>
</html>
